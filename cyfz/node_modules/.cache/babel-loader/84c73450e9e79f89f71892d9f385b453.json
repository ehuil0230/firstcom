{"remainingRequest":"D:\\vueWorkspace\\cyfz\\node_modules\\babel-loader\\lib\\index.js!D:\\vueWorkspace\\cyfz\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\vueWorkspace\\cyfz\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\vueWorkspace\\cyfz\\src\\components\\upAndDown\\cyImageUpload.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\vueWorkspace\\cyfz\\src\\components\\upAndDown\\cyImageUpload.vue","mtime":1571369962409},{"path":"D:\\vueWorkspace\\cyfz\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\vueWorkspace\\cyfz\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\vueWorkspace\\cyfz\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\vueWorkspace\\cyfz\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/es6.number.constructor\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nexport default {\n  name: \"cyImageUpload\",\n  props: {\n    autoUp: {\n      //自动上传\n      type: Boolean,\n      default: false\n    },\n    fileNum: {\n      type: Number,\n      default: 1\n    },\n    canPreview: {\n      type: Boolean,\n      default: true\n    },\n    canDelete: {\n      type: Boolean,\n      default: true\n    },\n    relatedId: {\n      type: String,\n      default: '',\n      required: true\n    }\n  },\n  components: {},\n  data: function data() {\n    return {\n      disableOpen: false,\n      //是否能弹出默认的打开文件，默认打开\n      fileList: [],\n      image: {\n        relatedid: '',\n        MD5Path: '',\n        fileName: '',\n        url: ''\n      },\n      previewImageUrl: '',\n      previewDialogVisible: false\n    };\n  },\n  // 组件加载完，立刻请求关联图片\n  created: function created() {\n    window.console.log('cyImageUpload created-------------');\n    this.getImageFileByRelatedId();\n  },\n  watch: {\n    // 监听relatedId，如果改变，说明更换了新的详情\n    relatedId: function relatedId(newVal, oldVal) {\n      window.console.log('relatedId changed');\n      this.getImageFileByRelatedId();\n    },\n    image: function image(newVal, oldVal) {\n      window.console.log('image changed');\n\n      if (this.image.url) {\n        this.disableOpen = true;\n      } else {\n        this.disableOpen = false;\n      }\n    }\n  },\n  methods: {\n    getImageFileByRelatedId: function getImageFileByRelatedId() {\n      var that = this;\n\n      if (that.relatedId) {\n        /*请求业务接口*/\n        that.$$queryFileList({\n          \"relatedid\": that.relatedId\n        }).then(function (res) {\n          var data = res.info;\n\n          if (data && data.length != 0) {\n            window.console.log(data);\n            var param = {\n              \"relatedid\": that.relatedId,\n              \"MD5Path\": data.url,\n              \"fileName\": data.name\n            };\n\n            if (data instanceof Array) {\n              var index = data.length - 1;\n              that.image = param;\n              that.image.url = that.$api.upload.reqUrl + that.$api.upload.download + \"?md5Path=\" + data[index].md5path;\n            } else if (data instanceof Object) {\n              that.image = param;\n              that.image.url = that.$api.upload.reqUrl + that.$api.upload.download + \"?md5Path=\" + data.md5path;\n            }\n          } else {\n            that.clearImage();\n          }\n        }).catch(function (err) {\n          that.$message({\n            type: 'error',\n            message: \"获取图片失败\"\n          });\n        });\n      } else {\n        that.clearImage();\n      }\n    },\n    clearImage: function clearImage() {\n      var param = {\n        relatedid: '',\n        MD5Path: '',\n        fileName: '',\n        url: ''\n      };\n      this.image = param;\n    },\n    toUpload: function toUpload(params) {\n      window.console.log('image to upload success');\n      var that = this;\n      that.$$md5ByFile(params).then(function (res) {\n        var defaultParam = {\n          file: params.file,\n          md5: res.md5\n        };\n        that.$$md5CheckByFile(Object.assign(defaultParam, that.md5CheckParams)).then(function (checkRes) {\n          if (checkRes && checkRes.message === \"正常上传\") {\n            that.$$uploadFile(Object.assign(defaultParam, {\n              progress: params.onProgress\n            })).then(function (response) {\n              var resObj = {\n                fileExt: response.fileExt,\n                secretKey: response.secretKey,\n                fileSize: response.fileSize,\n                name: response.fileSrcName,\n                url: response.url,\n                md5: response.md5,\n                relatedid: that.relatedId\n              };\n              return resObj;\n            }).then(function (resObj) {\n              var param = {\n                \"relatedid\": that.relatedId,\n                \"MD5Path\": resObj.url,\n                \"fileName\": resObj.name\n              };\n              that.$$insertFileInfo(param).then(function (res) {\n                // window.console.log(res)\n                var sucObj = {\n                  name: param.fileName,\n                  relatedid: param.relatedid,\n                  url: param.MD5Path,\n                  uuid: res.info\n                };\n                that.image = param; // 将图片回显\n\n                that.image.url = that.$api.upload.reqUrl + that.$api.upload.download + \"?md5Path=\" + sucObj.url; //上传成功 调用onSuccess方法，否则没有完成图标,处理自己的逻辑\n                // params.onSuccess(sucObj)\n              }).catch(function (err) {\n                that.$message({\n                  type: 'error',\n                  message: \"上传失败\"\n                });\n              });\n            }).catch(function () {\n              that.$message({\n                type: 'error',\n                message: \"上传失败\"\n              }); //上传失败 调用onError方法\n              //处理自己的逻辑\n              // params.onError(error)\n            });\n          } else if (checkRes && checkRes.message === \"0\") {\n            /*//上传成功 调用onSuccess方法，否则没有完成图标,处理自己的逻辑\n            params.onSuccess(sucObj)*/\n            // window.console.log(checkRes);\n\n            /*已上传，加入表格*/\n            var obj = {\n              \"relatedid\": that.relatedId,\n              \"MD5Path\": checkRes.url,\n              \"fileName\": params.file.name\n            };\n            that.$$insertFileInfo(obj).then(function (res) {\n              // window.console.log(res)\n              var sucObj = {\n                name: obj.fileName,\n                relatedid: obj.relatedid,\n                url: obj.MD5Path,\n                uuid: res.info\n              };\n              that.image = obj; // 将图片回显\n\n              that.image.url = that.$api.upload.reqUrl + that.$api.upload.download + \"?md5Path=\" + sucObj.url;\n            }).catch(function (err) {\n              that.$message({\n                type: 'error',\n                message: \"上传失败\"\n              });\n            });\n            params.onSuccess(checkRes);\n          } else {\n            that.$message({\n              type: 'error',\n              message: \"上传失败\"\n            });\n          }\n        });\n      });\n    },\n    // 上传前验证文件格式，只能是jpeg/png后缀的图片\n    beforeImageUpload: function beforeImageUpload(file) {\n      window.console.log('image before upload success');\n      var isJPG = file.type === 'image/jpeg' || file.type === 'image/png';\n\n      if (!isJPG) {\n        this.$message.error('上传头像图片只能是 JPG 或 PNG 格式!');\n      }\n\n      return isJPG;\n    },\n    handleImagePreview: function handleImagePreview(file) {\n      this.previewImageUrl = file.url;\n      this.previewDialogVisible = true;\n    },\n    handleImageRemove: function handleImageRemove(file, fileList) {\n      window.console.log('image delete success');\n      this.fileList = [];\n      this.image.url = '';\n      this.image.fileName = '';\n      this.image.MD5Path = ''; // 删除图片后就可以上传了\n\n      this.disableOpen = false;\n    },\n    handleImageUpload: function handleImageUpload(response, file, fileList) {\n      window.console.log('image upload success'); // 上传图片后就不能上传了\n\n      this.disableOpen = true;\n    },\n    handleImageChange: function handleImageChange(file, fileList) {\n      window.console.log('image change success');\n    }\n  }\n};",{"version":3,"sources":["cyImageUpload.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\r\n    <div>\r\n        <el-upload\r\n                ref=\"upload\"\r\n                class=\"avatar-uploader\"\r\n                action=\"#\"\r\n                :show-file-list=\"false\"\r\n                :file-list=\"fileList\"\r\n                :auto-upload=\"autoUp\"\r\n                :limit=\"fileNum\"\r\n                :disabled=\"disableOpen\"\r\n                :http-request=\"toUpload\"\r\n                :before-upload=\"beforeImageUpload\"\r\n                :on-success=\"handleImageUpload\"\r\n                :on-remove=\"handleImageRemove\"\r\n                :on-change=\"handleImageChange\">\r\n            <div class=\"el-upload-wrapper\" v-if=\"image.url != ''\">\r\n                <img :src=\"image.url\" class=\"el-upload-list__item-thumbnail avatar\">\r\n                <span class=\"el-upload-item-actions\">\r\n                    <span v-if=\"canPreview\"\r\n                          class=\"el-upload-item-preview\"\r\n                          @click=\"handleImagePreview(image)\">\r\n                        <i class=\"el-icon-zoom-in\"></i>\r\n                    </span>\r\n                    <span v-if=\"canDelete\"\r\n                          class=\"el-upload-item-delete\"\r\n                          @click=\"handleImageRemove(image)\">\r\n                        <i class=\"el-icon-delete\"></i>\r\n                    </span>\r\n                </span>\r\n            </div>\r\n            <i v-else slot=\"default\" class=\"el-icon-plus avatar-uploader-icon\"></i>\r\n        </el-upload>\r\n        <el-dialog :visible.sync=\"previewDialogVisible\" :modal=\"false\">\r\n            <img width=\"100%\" :src=\"previewImageUrl\" alt=\"\">\r\n        </el-dialog>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n    export default {\r\n        name: \"cyImageUpload\",\r\n        props: {\r\n            autoUp: {//自动上传\r\n                type: Boolean,\r\n                default: false,\r\n            },\r\n            fileNum: {\r\n                type: Number,\r\n                default: 1,\r\n            },\r\n            canPreview: {\r\n                type: Boolean,\r\n                default: true\r\n            },\r\n            canDelete: {\r\n                type: Boolean,\r\n                default: true\r\n            },\r\n            relatedId: {\r\n                type: String,\r\n                default: '',\r\n                required: true\r\n            }\r\n        },\r\n        components: {\r\n\r\n        },\r\n        data() {\r\n            return {\r\n                disableOpen: false,//是否能弹出默认的打开文件，默认打开\r\n                fileList:[],\r\n                image: {\r\n                    relatedid: '',\r\n                    MD5Path: '',\r\n                    fileName: '',\r\n                    url: ''\r\n                },\r\n                previewImageUrl: '',\r\n                previewDialogVisible: false\r\n            }\r\n        },\r\n        // 组件加载完，立刻请求关联图片\r\n        created() {\r\n            window.console.log('cyImageUpload created-------------')\r\n            this.getImageFileByRelatedId()\r\n        },\r\n        watch: {\r\n            // 监听relatedId，如果改变，说明更换了新的详情\r\n            relatedId(newVal, oldVal) {\r\n                window.console.log('relatedId changed')\r\n                this.getImageFileByRelatedId()\r\n            },\r\n            image(newVal, oldVal) {\r\n                window.console.log('image changed')\r\n                if (this.image.url) {\r\n                    this.disableOpen = true\r\n                } else {\r\n                    this.disableOpen = false\r\n                }\r\n            }\r\n        },\r\n        methods: {\r\n            getImageFileByRelatedId() {\r\n                let that = this;\r\n                if (that.relatedId) {\r\n                    /*请求业务接口*/\r\n                    that.$$queryFileList({\r\n                        \"relatedid\": that.relatedId\r\n                    }).then((res) => {\r\n                        let data = res.info\r\n                        if (data && data.length != 0){\r\n                            window.console.log(data)\r\n                            let param = {\r\n                                \"relatedid\": that.relatedId,\r\n                                \"MD5Path\": data.url,\r\n                                \"fileName\": data.name\r\n                            }\r\n                            if (data instanceof Array) {\r\n                                let index = data.length - 1;\r\n                                that.image = param\r\n                                that.image.url = that.$api.upload.reqUrl +\r\n                                    that.$api.upload.download+\"?md5Path=\"+data[index].md5path\r\n                            } else if (data instanceof Object){\r\n                                that.image = param\r\n                                that.image.url = that.$api.upload.reqUrl +\r\n                                    that.$api.upload.download+\"?md5Path=\"+data.md5path\r\n                            }\r\n                        }else {\r\n                            that.clearImage()\r\n                        }\r\n                    }).catch(function (err) {\r\n                        that.$message({\r\n                            type: 'error',\r\n                            message: \"获取图片失败\"\r\n                        })\r\n                    })\r\n                } else {\r\n                    that.clearImage()\r\n                }\r\n            },\r\n            clearImage() {\r\n                let param = {\r\n                    relatedid: '',\r\n                    MD5Path: '',\r\n                    fileName: '',\r\n                    url: ''\r\n                }\r\n                this.image = param\r\n            },\r\n            toUpload(params) {\r\n                window.console.log('image to upload success')\r\n\r\n                let that = this;\r\n                that.$$md5ByFile(params).then((res) => {\r\n                    let defaultParam = {\r\n                        file: params.file,\r\n                        md5: res.md5\r\n                    };\r\n                    that.$$md5CheckByFile(Object.assign(defaultParam, that.md5CheckParams)).then((checkRes) => {\r\n                        if (checkRes && checkRes.message === \"正常上传\") {\r\n                            that.$$uploadFile(Object.assign(defaultParam, {\r\n                                progress: params.onProgress\r\n                            })).then(function (response) {\r\n                                let resObj = {\r\n                                    fileExt: response.fileExt,\r\n                                    secretKey: response.secretKey,\r\n                                    fileSize: response.fileSize,\r\n                                    name: response.fileSrcName,\r\n                                    url: response.url,\r\n                                    md5: response.md5,\r\n                                    relatedid: that.relatedId,\r\n                                };\r\n                                return resObj;\r\n                            }).then((resObj) => {\r\n                                let param = {\r\n                                    \"relatedid\": that.relatedId,\r\n                                    \"MD5Path\": resObj.url,\r\n                                    \"fileName\": resObj.name\r\n                                }\r\n                                that.$$insertFileInfo(param).then((res) => {\r\n                                    // window.console.log(res)\r\n                                    let sucObj = {\r\n                                        name: param.fileName,\r\n                                        relatedid: param.relatedid,\r\n                                        url: param.MD5Path,\r\n                                        uuid: res.info\r\n                                    }\r\n                                    that.image = param\r\n                                    // 将图片回显\r\n                                    that.image.url = that.$api.upload.reqUrl +\r\n                                        that.$api.upload.download+\"?md5Path=\"+sucObj.url\r\n\r\n                                    //上传成功 调用onSuccess方法，否则没有完成图标,处理自己的逻辑\r\n                                    // params.onSuccess(sucObj)\r\n                                }).catch(function (err) {\r\n                                    that.$message({\r\n                                        type: 'error',\r\n                                        message: \"上传失败\"\r\n                                    })\r\n                                })\r\n                            }).catch(() => {\r\n                                that.$message({\r\n                                    type: 'error',\r\n                                    message: \"上传失败\"\r\n                                })\r\n                                //上传失败 调用onError方法\r\n                                //处理自己的逻辑\r\n                                // params.onError(error)\r\n                            })\r\n                        } else if (checkRes && checkRes.message === \"0\") {\r\n                            /*//上传成功 调用onSuccess方法，否则没有完成图标,处理自己的逻辑\r\n                            params.onSuccess(sucObj)*/\r\n                            // window.console.log(checkRes);\r\n                            /*已上传，加入表格*/\r\n                            let obj = {\r\n                                \"relatedid\": that.relatedId,\r\n                                \"MD5Path\": checkRes.url,\r\n                                \"fileName\": params.file.name\r\n                            }\r\n                            that.$$insertFileInfo(obj).then((res) => {\r\n                                // window.console.log(res)\r\n                                let sucObj = {\r\n                                    name: obj.fileName,\r\n                                    relatedid: obj.relatedid,\r\n                                    url: obj.MD5Path,\r\n                                    uuid: res.info\r\n                                }\r\n                                that.image = obj\r\n                                // 将图片回显\r\n                                that.image.url = that.$api.upload.reqUrl +\r\n                                    that.$api.upload.download+\"?md5Path=\"+sucObj.url\r\n\r\n                            }).catch(function (err) {\r\n                                that.$message({\r\n                                    type: 'error',\r\n                                    message: \"上传失败\"\r\n                                })\r\n                            })\r\n                            params.onSuccess(checkRes)\r\n                        } else {\r\n                            that.$message({\r\n                                type: 'error',\r\n                                message: \"上传失败\"\r\n                            })\r\n                        }\r\n                    })\r\n                })\r\n            },\r\n            // 上传前验证文件格式，只能是jpeg/png后缀的图片\r\n            beforeImageUpload(file) {\r\n                window.console.log('image before upload success')\r\n\r\n                const isJPG = (file.type === 'image/jpeg') ||\r\n                    (file.type === 'image/png');\r\n\r\n                if (!isJPG) {\r\n                    this.$message.error('上传头像图片只能是 JPG 或 PNG 格式!');\r\n                }\r\n                return isJPG;\r\n            },\r\n            handleImagePreview(file) {\r\n                this.previewImageUrl = file.url;\r\n                this.previewDialogVisible = true;\r\n            },\r\n            handleImageRemove(file, fileList) {\r\n                window.console.log('image delete success')\r\n                this.fileList=[]\r\n                this.image.url = ''\r\n                this.image.fileName = ''\r\n                this.image.MD5Path = ''\r\n\r\n                // 删除图片后就可以上传了\r\n                this.disableOpen = false\r\n\r\n            },\r\n            handleImageUpload(response, file, fileList) {\r\n                window.console.log('image upload success')\r\n\r\n                // 上传图片后就不能上传了\r\n                this.disableOpen = true\r\n            },\r\n            handleImageChange(file, fileList){\r\n                window.console.log('image change success')\r\n            },\r\n        }\r\n    }\r\n</script>\r\n\r\n<style scoped>\r\n    /deep/ .avatar-uploader{\r\n        position: relative;\r\n        text-align: center;\r\n    }\r\n    .avatar-uploader /deep/ .el-upload {\r\n        width: 164px;\r\n        height: 164px;\r\n        border: 1px dashed #d9d9d9;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        position: relative;\r\n        left: auto;\r\n        transform: none;\r\n        overflow: hidden;\r\n    }\r\n    .avatar-uploader .el-upload:hover {\r\n        border-color: #409EFF;\r\n    }\r\n    .avatar-uploader-icon {\r\n        font-size: 28px;\r\n        color: #8c939d;\r\n        width: 164px;\r\n        height: 164px;\r\n        line-height: 164px;\r\n        text-align: center;\r\n    }\r\n    .avatar {\r\n        width: 164px;\r\n        height: 164px;\r\n        display: block;\r\n    }\r\n    .avatar-uploader .el-upload-wrapper {\r\n        position: relative;\r\n    }\r\n    .avatar-uploader .el-upload-item-actions {\r\n        position: absolute;\r\n        width: 100%;\r\n        height: 100%;\r\n        left: 0;\r\n        top: 0;\r\n        cursor: default;\r\n        text-align: center;\r\n        color: #fff;\r\n        opacity: 0;\r\n        font-size: 20px;\r\n        background-color: rgba(0,0,0,.5);\r\n        transition: opacity .3s;\r\n    }\r\n    .avatar-uploader .el-upload-item-actions:hover {\r\n        opacity: 1;\r\n    }\r\n    .avatar-uploader .el-upload-item-actions::after {\r\n        display: inline-block;\r\n        content: \"\";\r\n        height: 100%;\r\n        vertical-align: middle;\r\n    }\r\n    .avatar-uploader .el-upload-item-actions:hover span{\r\n        display: inline-block;\r\n    }\r\n    .avatar-uploader .el-upload-item-actions span{\r\n        cursor: pointer;\r\n        margin: 0 15px;\r\n    }\r\n</style>"],"sourceRoot":"src/components/upAndDown"}]}